<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>POIs in Schiltern</title>
    <link rel="stylesheet" href="../node_modules/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="../node_modules/leaflet.locatecontrol/dist/L.Control.Locate.min.css">
    <style>
        body {
            margin: 0;
        }

        html, body, #map {
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script src="../node_modules/jquery/dist/jquery.min.js"></script>
<script src="../node_modules/leaflet/dist/leaflet.js"></script>
<script src="../node_modules/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="../node_modules/moment/min/moment-with-locales.min.js"></script>
<script src="../node_modules/opening_hours/opening_hours.js"></script>
<script>
    $(document).ready(function () {
        moment.locale(window.navigator.userLanguage || window.navigator.language);
        var map = L.map('map').setView([48.51579416571888, 15.6255304813385], 16);
        var layer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var LeafIcon = L.Icon.extend({
            options: {
//            shadowUrl: 'leaf-shadow.png',
//         //   iconSize:     [38, 95],
//            shadowSize:   [50, 64],
                iconAnchor: [16, 35],
                popupAnchor: [0, -35]
            }
        });

        var categories = {},
            category;

        var geojsonLayer = L.geoJson(null, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {icon: new LeafIcon({iconUrl: 'images/' + feature.properties.own.icon + '.png'})});
            },
            onEachFeature: function (feature, layer) {
                // Check if feature is a polygon
                if (feature.geometry.type === 'Polygon') {
                    // Don't stroke and do opaque fill
                    layer.setStyle({
                        'weight': 0,
                        'fillOpacity': 0
                    });
                    // Get center of bounds
                    var center = layer.getBounds().getCenter();
                    // Use center to put marker on map
                    layer = L.marker(center, {icon: new LeafIcon({iconUrl: 'images/' + feature.properties.own.icon + '.png'})}).addTo(map);
                } else {
                }
                var popuptext = "";
                if (feature.properties.name) {
                    popuptext += feature.properties.name + "<br>"
                }
                if (feature.properties.opening_hours) {
                    var oh = new opening_hours(feature.properties.opening_hours, {
                        "address": {
                            "state": "Niederösterreich",
                            "country": "Österreich",
                            "country_code": "at"
                        }
                    });
                    if (!oh.getUnknown()) {
                        var change = moment(oh.getNextChange());
                        if (oh.getState()) {
                            popuptext += "hat geöffnet<br>schließt " + change.calendar() + " (" + change.fromNow() + ")";
                        } else {
                            popuptext += "hat geschlossen<br>öffnet " + change.calendar() + " (" + change.fromNow() + ")";
                        }
                    }
//                    console.warn(oh.getState());
//                    popuptext += oh.getState();
                }
                if (popuptext) {
                    layer.bindPopup(popuptext);
                }

                category = feature.properties.own.category;
                // Initialize the category array if not already set.
                if (typeof categories[category] === "undefined") {
                    categories[category] = [];
                }
                categories[category].push(layer);
            }
        });
        var mapLayers = {
            'Standard': layer
        };

        var attribution = function () {
            return 'Icons von <a href="https://mapicons.mapsmarker.com">mapicons.mapsmarker.com</a> ' +
                '(<a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY SA 3.0</a>)';
        };
        var overlays = {};
        var categoryName, categoryArray, categoryLG;
        $.ajax({
            dataType: "json",
            url: "poi.json",
            success: function (data) {
                geojsonLayer.addData(data);
                map.fitBounds(geojsonLayer.getBounds());
                for (categoryName in categories) {
                    categoryArray = categories[categoryName];
                    categoryLG = L.layerGroup(categoryArray);

                    categoryLG.categoryName = categoryName;
                    categoryLG.getAttribution = attribution;

                    overlays[categoryName] = categoryLG;

                    categoryLG.addTo(map);
                }
                var control = L.control.layers(mapLayers, overlays).addTo(map);
            }
        });
        L.control.locate().addTo(map);
    });
</script>
</body>
</html>
